---
title: "Data Analysis SMARTTESTERÂ®"
author: "Hannah Rausch (adapted from Ivan Calandra & Lisa Schunk)"
date: "`r format(Sys.time(), usetz = TRUE)`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    theme: cerulean
    highlight: pygments
    number_sections: true
  github_document: 
    toc: true
    toc_depth: 3
    html_preview: false
bibliography: grateful-refs.bib
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_format = "all", knit_root_dir = rprojroot::find_rstudio_root_file()) })
---

```{r Knitr Options, include = FALSE}
knitr::opts_chunk$set(comment = NA, message = FALSE, indent = "", error = TRUE)
```

---

# Goal of the script
Analysis of the SMARTTESTER sensor data containing the parameters depth, force, friction and velocity.
This is achieved by creating line graphs displaying the data of each parameter for each of the four samples.
Additionally, descriptive statistics of each parameter for each sample is retrieved.
A bibliography of the R packages used is found at the end of the script.


```{r}
dir_in <- "a_raw_data_smarttester"
dir_out <- "b_output_data_smarttester"
```

Raw data must be located in `r paste0("~/", dir_in)`.  
Formatted data will be saved in `r paste0("~/", dir_out)`.
The knit directory for this script is the project directory.

---

# Load packages
```{r}
pack_to_load <- c("tidyverse", "R.utils", "openxlsx", "tools", "patchwork", "doBy", "ggrepel", "ggplot2", "grateful", "viridis")
sapply(pack_to_load, library, character.only = TRUE, logical.return = TRUE) 
```

---

# Get name, path and information of the file
```{r}
data_file <- list.files(dir_in, pattern = "\\.xlsx$", full.names = TRUE)
data_file
```


# Load data into R object
```{r}
imp_data <- read.xlsx(data_file)
str(imp_data)
```

The imported file is: "`r paste0("~/", data_file)`"  

---

# Plot the sensor data of each parameter with strokes as line graphs
```{r}
# Split the data into the individual 4 samples.
sp <- split(imp_data, imp_data[["Sample"]])
str(sp)

# Select parameters to plot.
y_var <- c("Force", "Friction", "Depth", "Velocity")

# Plot every 40th stroke.
for (i in seq_along(sp)) {
  # Create a sequence of every 40th stroke per sample that includes the first and the last strokes.
   seq_st <- seq(1, length(unique(sp[[i]][["Stroke"]])), by = 40) %>% 
    c(max(unique(sp[[i]][["Stroke"]])))
  
  # Create a subset of every 40th stroke and a subset of the first 50 strokes per sample.
  dat_i_40th <- filter(sp[[i]], Stroke %in% seq_st)
  dat_i_50 <- filter(sp[[i]], Stroke %in% 1:50)
  
  # Pivot to longer format for facet plots.
  data_long_40th <- select(dat_i_40th, all_of(c("Relative_pos", y_var, "Stroke"))) %>%
             pivot_longer(all_of(y_var), names_to = "parameter", values_to = "value")
  str(data_long_40th)
  data_long_50 <- select(dat_i_50, all_of(c("Relative_pos", y_var, "Stroke"))) %>%
             pivot_longer(all_of(y_var), names_to = "parameter", values_to = "value") 
  str(data_long_50)
  
  # Create axes labels with units.
  param.labs <- c("Force [N]", "Friction [N]", "Depth [mm]", "Velocity [mm/s]")
  names(param.labs) <- y_var
    
  # Plot
  p1 <- ggplot(data = data_long_40th, aes(x = Relative_pos, y = value, color = Stroke)) +
    geom_line(aes(group = Stroke), alpha = 0.3) + 
    # Wrap around parameters with free y-scales.
    facet_wrap(~ parameter, scales = "free_y", ncol = 1, labeller = labeller(parameter = param.labs)) +
    labs(x = "Distance [mm]", y = NULL) +
    # Reverse the legend starting with 0 going to 2000 strokes.
    scale_color_viridis(trans = "reverse") + 
    # Change the 'Distance [mm]' in the x-legend.
    scale_x_continuous(breaks=c(0, 35, 70, 105, 140)) +
    theme_minimal()
  
  # Plot only the first 50 strokes per sample.
  p2 <- ggplot(data = data_long_50, aes(x = Relative_pos, y = value, color = Stroke)) +
    geom_line(aes(group = Stroke), alpha = 0.3) + 
    # Wrap around parameters with free y-scales.
    facet_wrap(~ parameter, scales = "free_y", ncol = 1, labeller = labeller(parameter = param.labs)) +
    
    labs(x = "Distance [mm]", y = NULL) +
    # Reverse the legend to start with 0 and reach 2000 strokes.  
    scale_color_viridis(trans = "reverse") + 
    # Change the 'Distance [mm]' in the x-legend.
    scale_x_continuous(breaks=c(0, 35, 70, 105, 140)) +
    theme_minimal()

  # Patchwork the plot.
  p <- p2 + p1 + plot_annotation(title = names(sp)[i]) 
  print(p)
  # Save the plot as a PDF.
  file_out <- paste0(file_path_sans_ext(basename(data_file)), "_plot_", names(sp)[i], ".pdf") %>%
    gsub("b_", "d_", .)
  ggsave(filename = file_out, plot = p, path = dir_out, device = "pdf")
} 
```

---

# Descriptive statistics
## Create function to compute the statistics in bulk
```{r Function}
NMinMaxMeanMedSd <- function(x){
  y <- x[!is.na(x)]     # Exclude NAs
  n_test <- length(y)   # Sample size (n)
  min_test <- min(y)    # Minimum
  max_test <- max(y)    # Maximum
  mean_test <- mean(y)  # Mean
  med_test <- median(y) # Median
  sd_test <- sd(y)      # Standard deviation
  out <- c(n_test, min_test, max_test, mean_test, med_test, sd_test) # Concatenate
  names(out) <- c("n", "min", "max", "mean", "median", "sd")         # Name values
  return(out)                                                        # Object to return
}
N.distinct <- function(x){
  y <- x[!is.na(x)]     # Exclude NAs
  n_test <- length(y)   # Sample size (n)
  unique_test <- length(unique(y)) # Number of unique values
  out <- c(n_test, unique_test) # Concatenate
  names(out) <- c("n", "distinct")# Name values
  return(out)           # Object to return
}
```

## Summary statistics
```{r}
all_stats <- summaryBy(.~ Sample, data = imp_data[c(y_var, "Sample")], FUN = NMinMaxMeanMedSd)
all_stats
stroke_stats <- summaryBy(.~ Sample, data = imp_data[c("Stroke", "Sample")], FUN = N.distinct)
stroke_stats
```

## Export statistics
```{r}
write.xlsx(list(Stroke = stroke_stats, Parameters = all_stats), 
           file = paste0(dir_out, "/descriptivestats_smarttester_stepmm.xlsx"))
```

---

# sessionInfo()

```{r}
sessionInfo()
```


---


# Cite R packages used

```{r, echo = FALSE}
cite_packages(pkgs = pack_to_load, output = "paragraph", include.RStudio = TRUE, out.dir = "Script")
```


## References